const resumeButton = document.getElementById('resumeButton'); // New resume button

// Flag to check if scanning is paused
let isPaused = false;

// Function to pause scanning
function pauseScanner() {
    isPaused = true;
    Quagga.stop(); // Stop the scanner
    resumeButton.style.display = 'inline-block'; // Show the resume button
    outputElement.textContent = "Scanning paused. Click 'Resume Scanning' to continue.";
}

// Function to resume scanning
function resumeScanner() {
    isPaused = false;
    Quagga.start(); // Restart the scanner
    resumeButton.style.display = 'none'; // Hide the resume button
    outputElement.textContent = "Scanning resumed. Point your camera at barcodes.";
}

// Update the barcode detection part to play any audio when a barcode is detected
Quagga.onDetected((data) => {
    const code = data.codeResult.code;

    // Play the audio on barcode detection (can be any custom audio file)
    const detectionSound = new Audio('https://www.soundjay.com/button/beep-07.mp3');
    detectionSound.play();

    // Multiple frame verification for accuracy
    if (lastDetected === code) {
        confirmCounter++;
        if (confirmCounter >= 3) { // Require detection over 3 frames
            confirmCounter = 0;
            processBarcode(code);
        }
    } else {
        lastDetected = code;
        confirmCounter = 1;
    }
});

// Event listener to resume the scanner
resumeButton.addEventListener('click', resumeScanner);

// Modify the initializeCameraAndScanner function to include the pause feature
async function initializeCameraAndScanner() {
    try {
        // Hide the initialize button after user interaction
        initializeButton.style.display = 'none';

        // Find the back camera
        const devices = await navigator.mediaDevices.enumerateDevices();
        const backCamera = devices.find(
            (device) => device.kind === "videoinput" && device.label.toLowerCase().includes("back")
        );

        const constraints = backCamera
            ? { video: { deviceId: { exact: backCamera.deviceId }, width: 1280, height: 720 } }
            : { video: { facingMode: "environment", width: 1280, height: 720 } };

        // Request the video stream
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;

        // Initialize QuaggaJS
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoElement,
                constraints
            },
            decoder: {
                readers: ["ean_reader"], // Restrict to the specific barcode type
            },
            locator: {
                patchSize: "large", // More accurate detection
                halfSample: false
            },
            locate: true, // Detect barcodes in varying positions
            frequency: 10 // Process fewer frames for accuracy
        }, function (err) {
            if (err) {
                console.error("Quagga initialization failed:", err);
                outputElement.textContent = "Error initializing barcode scanner.";
                outputElement.classList.add("error");
                return;
            }
            Quagga.start();
            outputElement.textContent = "Point your camera at barcodes.";
        });

        // Listen for barcode detection
        Quagga.onDetected((data) => {
            const code = data.codeResult.code;

            // Play the audio on barcode detection (can be any custom audio file)
            const detectionSound = new Audio('https://www.soundjay.com/button/beep-07.mp3');
            detectionSound.play();

            // Multiple frame verification for accuracy
            if (lastDetected === code) {
                confirmCounter++;
                if (confirmCounter >= 3) { // Require detection over 3 frames
                    confirmCounter = 0;
                    processBarcode(code);
                }
            } else {
                lastDetected = code;
                confirmCounter = 1;
            }
        });
    } catch (error) {
        console.error("Error accessing camera or initializing scanner:", error);
        outputElement.textContent = "Error accessing the camera or initializing scanner.";
        outputElement.classList.add("error");
    }
}

// Add event listener to initialize the scanner on button click
initializeButton.addEventListener('click', initializeCameraAndScanner);
