<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner V20</title>
    <style>
        /* (Keep all the existing styles unchanged) */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
    <h1>Barcode Scanner V20</h1>
    <button id="initializeButton">Initialize Scanner</button>
    <video id="video" autoplay muted playsinline></video>
    <div id="latestBarcode">No barcode scanned yet.</div>
    <table id="barcodeList">
        <thead>
            <tr>
                <th>Value</th>
                <th>Type</th>
            </tr>
        </thead>
        <tbody>
            <!-- Barcode rows will be added here dynamically -->
        </tbody>
    </table>
    <div id="output">Initializing barcode scanner...</div>
    
    <!-- Add an audio element for the buzzer sound -->
    <audio id="beepSound" src="https://www.soundjay.com/button/beep-07.mp3"></audio>
    
    <!-- Modal for barcode confirmation -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="modal">
        <p>Is this barcode correct?</p>
        <p id="detectedBarcode"></p>
        <div id="barcodeInfo"></div>
        <div class="button-grid">
            <button class="confirm" onclick="confirmBarcode()">Correct</button>
            <button class="rescan" onclick="rescanBarcode()">Rescan</button>
            <button class="manual" onclick="enterManually()">Enter Manually</button>
            <button class="cancel" onclick="cancelBarcode()">Cancel</button>
        </div>
        <div id="manualEntry">
            <input type="text" id="manualBarcode" placeholder="Enter barcode manually">
            <button onclick="submitManualBarcode()">Submit</button>
        </div>
    </div>
    
    <script>
        const videoElement = document.getElementById('video');
        const outputElement = document.getElementById('output');
        const barcodeListElement = document.getElementById('barcodeList').getElementsByTagName('tbody')[0];
        const latestBarcodeElement = document.getElementById('latestBarcode');
        const beepSound = document.getElementById('beepSound');
        const initializeButton = document.getElementById('initializeButton');
        const modal = document.getElementById('modal');
        const modalOverlay = document.getElementById('modalOverlay');
        const detectedBarcodeElement = document.getElementById('detectedBarcode');
        const barcodeInfoElement = document.getElementById('barcodeInfo');
        const manualEntryElement = document.getElementById('manualEntry');
        const manualBarcodeInput = document.getElementById('manualBarcode');
        let lastDetected = '';
        let confirmCounter = 0;
        let currentBarcode = '';
        let isModalOpen = false;

        // Initialize the speech synthesis
        const synth = window.speechSynthesis;

        // Function to read out loud the detected barcode digit by digit
        function speakBarcode(barcode) {
            if (synth.speaking) {
                console.log("Speech synthesis is already in progress.");
                return;
            }

            // Split the barcode into individual digits
            const digits = barcode.split('');

            // Speak each digit with a slight delay
            digits.forEach((digit, index) => {
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(digit);
                    synth.speak(utterance);
                }, index * 500); // Add a 500ms delay between digits
            });
        }

        // (Keep all the other functions unchanged)

        // Function to update the UI with a scanned barcode
        function updateUIWithBarcode(barcode) {
            // Show the latest barcode at the top
            latestBarcodeElement.textContent = barcode ? `Latest Scanned: ${barcode}` : "Latest Scanned: (Empty)";

            // Add the barcode to the table with its type
            const barcodeType = getBarcodeType(barcode);
            const newRow = barcodeListElement.insertRow(0);
            const valueCell = newRow.insertCell(0);
            const typeCell = newRow.insertCell(1);
            valueCell.textContent = barcode || "(Empty)";
            typeCell.textContent = barcodeType;

            // Play the beep sound (only if barcode is not empty)
            if (barcode) {
                beepSound.currentTime = 0; // Reset sound to start
                beepSound.play();
            }

            // Read out the barcode digit by digit
            speakBarcode(barcode);
        }

        // Add event listener to initialize the scanner on button click
        initializeButton.addEventListener('click', initializeCameraAndScanner);
    </script>
</body>
</html>
